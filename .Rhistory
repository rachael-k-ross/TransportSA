linewidth=group),
#colour=trt,
#fill=trt)
#alpha=.2,
colour=color,
fill=color,
trim=TRUE,
#linewidth=0.7
) +
ylab("Density") +
xlab("Probability of adherence") +
theme_classic() +
scale_x_continuous(limits=c(0,1)) +
annotate("text", x=label1x, y=label1y,
label= as.character(label1),parse=TRUE,size=3) +
annotate("text", x=label2x, y=label2y,
label= as.character(label2),parse=TRUE,size=3) +
annotate("text", x=label3x, y=label3y,
label= as.character(label3),parse=TRUE,size=3) +
annotate("text", x=.03, y=tagy,
label= trt,size=3) +
scale_alpha_manual(values=c(0.1,0.4,0.8)) +
#scale_fill_manual(values=color) +
#scale_colour_manual(values=color) +
scale_linewidth_manual(values=c(.4,0.6,0.8)) +
theme(legend.position="none",
panel.grid.major.x = element_line(color = "lightgray",
linewidth = 0.05))
#scale_y_continuous(limits=c(0,40))
}
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,3,
0.52,8,
0.23,10,
12)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,45,
0.74,65,
.40,90,
115)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
mycolors <- c("darkgray","darkgray")
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,3,
0.52,8,
0.23,10,
12)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,45,
0.74,65,
.40,90,
115)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
mycolors <- c("#3C3C3C","#3C3C3C")
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,3,
0.52,8,
0.23,10,
12)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,45,
0.74,65,
.40,90,
115)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
mycolors <- c("#525252","#3C3C3C")
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,3,
0.52,8,
0.23,10,
12)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,45,
0.74,65,
.40,90,
115)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
mycolors <- c("#525252","#525252")
toplotadh <- function(trt,color,label1x,label1y,
label2x,label2y,label3x,label3y,tagy){
ggplot() +
geom_density(data = foradhplot[foradhplot$trt==trt,],
aes(x=adh,
group =group,
alpha=group,
linewidth=group,
y=after_stat(scaled)),
#colour=trt,
#fill=trt)
#alpha=.2,
colour=color,
fill=color,
trim=TRUE,
#linewidth=0.7
) +
ylab("Density") +
xlab("Probability of adherence") +
theme_classic() +
scale_x_continuous(limits=c(0,1)) +
annotate("text", x=label1x, y=label1y,
label= as.character(label1),parse=TRUE,size=3) +
annotate("text", x=label2x, y=label2y,
label= as.character(label2),parse=TRUE,size=3) +
annotate("text", x=label3x, y=label3y,
label= as.character(label3),parse=TRUE,size=3) +
annotate("text", x=.03, y=tagy,
label= trt,size=3) +
scale_alpha_manual(values=c(0.1,0.4,0.8)) +
#scale_fill_manual(values=color) +
#scale_colour_manual(values=color) +
scale_linewidth_manual(values=c(.4,0.6,0.8)) +
theme(legend.position="none",
panel.grid.major.x = element_line(color = "lightgray",
linewidth = 0.05))
#scale_y_continuous(limits=c(0,40))
}
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,3,
0.52,8,
0.23,10,
12)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,45,
0.74,65,
.40,90,
115)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
toplotadh <- function(trt,color,label1x,label1y,
label2x,label2y,label3x,label3y,tagy){
ggplot() +
geom_density(data = foradhplot[foradhplot$trt==trt,],
aes(x=adh,
group =group,
alpha=group,
linewidth=group,
y=after_stat(scaled)),
#colour=trt,
#fill=trt)
#alpha=.2,
colour=color,
fill=color,
trim=TRUE,
#linewidth=0.7
) +
ylab("Density") +
xlab("Probability of adherence") +
theme_classic() +
scale_x_continuous(limits=c(0,1)) +
annotate("text", x=label1x, y=label1y,
label= as.character(label1),parse=TRUE,size=3) +
annotate("text", x=label2x, y=label2y,
label= as.character(label2),parse=TRUE,size=3) +
annotate("text", x=label3x, y=label3y,
label= as.character(label3),parse=TRUE,size=3) +
annotate("text", x=.03, y=tagy,
label= trt,size=3) +
scale_alpha_manual(values=c(0.1,0.4,0.8)) +
#scale_fill_manual(values=color) +
#scale_colour_manual(values=color) +
scale_linewidth_manual(values=c(.4,0.6,0.8)) +
theme(legend.position="none",
panel.grid.major.x = element_line(color = "lightgray",
linewidth = 0.05))
#scale_y_continuous(limits=c(0,40))
}
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,3,
0.52,8,
0.23,10,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,45,
0.74,65,
.40,90,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,.4,
0.52,.75,
0.23,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,.4,
0.74,.75,
.40,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
toplotadh <- function(trt,color,label1x,label1y,
label2x,label2y,label3x,label3y,tagy){
ggplot() +
geom_density(data = foradhplot[foradhplot$trt==trt,],
aes(x=adh,
group =group,
alpha=group,
linewidth=group,
y=after_stat(scaled)),
#colour=trt,
#fill=trt)
#alpha=.2,
colour=color,
fill=color,
trim=TRUE,
#linewidth=0.7
) +
ylab("Scaled density") +
xlab("Probability of adherence") +
theme_classic() +
scale_x_continuous(limits=c(0,1)) +
scale_y_continuous(breaks=seq(0,1,by=0.2)) +
annotate("text", x=label1x, y=label1y,
label= as.character(label1),parse=TRUE,size=3) +
annotate("text", x=label2x, y=label2y,
label= as.character(label2),parse=TRUE,size=3) +
annotate("text", x=label3x, y=label3y,
label= as.character(label3),parse=TRUE,size=3) +
annotate("text", x=.03, y=tagy,
label= trt,size=3) +
scale_alpha_manual(values=c(0.1,0.4,0.8)) +
#scale_fill_manual(values=color) +
#scale_colour_manual(values=color) +
scale_linewidth_manual(values=c(.4,0.6,0.8)) +
theme(legend.position="none",
panel.grid.major.x = element_line(color = "lightgray",
linewidth = 0.05))
#scale_y_continuous(limits=c(0,40))
}
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,.4,
0.52,.75,
0.23,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,.4,
0.74,.75,
.40,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,.4,
0.52,.85,
0.23,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,.6,
0.74,.75,
.40,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
savefig(adhplot1,5,3.5)
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.79,.4,
0.5,.95,
0.22,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.96,.6,
0.75,.75,
.39,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
savefig(adhplot1,5,3.5)
toplotadh <- function(trt,color,label1x,label1y,
label2x,label2y,label3x,label3y,tagy){
ggplot() +
geom_density(data = foradhplot[foradhplot$trt==trt,],
aes(x=adh,
group =group,
alpha=group,
linewidth=group,
y=after_stat(scaled)),
#colour=trt,
#fill=trt)
#alpha=.2,
colour=color,
fill=color,
trim=TRUE,
#linewidth=0.7
) +
ylab("Scaled density") +
xlab("Probability of adherence") +
theme_classic() +
scale_x_continuous(limits=c(0,1)) +
scale_y_continuous(breaks=seq(0,1,by=0.2)) +
annotate("text", x=label1x, y=label1y,
label= as.character(label1),parse=TRUE,size=2) +
annotate("text", x=label2x, y=label2y,
label= as.character(label2),parse=TRUE,size=2) +
annotate("text", x=label3x, y=label3y,
label= as.character(label3),parse=TRUE,size=2) +
annotate("text", x=.03, y=tagy,
label= trt,size=3) +
scale_alpha_manual(values=c(0.1,0.4,0.8)) +
#scale_fill_manual(values=color) +
#scale_colour_manual(values=color) +
scale_linewidth_manual(values=c(.4,0.6,0.8)) +
theme(legend.position="none",
panel.grid.major.x = element_line(color = "lightgray",
linewidth = 0.05))
#scale_y_continuous(limits=c(0,40))
}
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.80,.4,
0.5,.97,
0.22,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.97,.6,
0.75,.75,
.39,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
savefig(adhplot1,5,3.5)
toplotadh <- function(trt,color,label1x,label1y,
label2x,label2y,label3x,label3y,tagy){
ggplot() +
geom_density(data = foradhplot[foradhplot$trt==trt,],
aes(x=adh,
group =group,
alpha=group,
linewidth=group,
y=after_stat(scaled)),
#colour=trt,
#fill=trt)
#alpha=.2,
colour=color,
fill=color,
trim=TRUE,
#linewidth=0.7
) +
ylab("Scaled density") +
xlab("Probability of adherence") +
theme_classic() +
scale_x_continuous(limits=c(0,1)) +
scale_y_continuous(breaks=seq(0,1,by=0.2)) +
annotate("text", x=label1x, y=label1y,
label= as.character(label1),parse=TRUE,size=2.7) +
annotate("text", x=label2x, y=label2y,
label= as.character(label2),parse=TRUE,size=2.7) +
annotate("text", x=label3x, y=label3y,
label= as.character(label3),parse=TRUE,size=2.7) +
annotate("text", x=.03, y=tagy,
label= trt,size=3) +
scale_alpha_manual(values=c(0.1,0.4,0.8)) +
#scale_fill_manual(values=color) +
#scale_colour_manual(values=color) +
scale_linewidth_manual(values=c(.4,0.6,0.8)) +
theme(legend.position="none",
panel.grid.major.x = element_line(color = "lightgray",
linewidth = 0.05))
#scale_y_continuous(limits=c(0,40))
}
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.80,.4,
0.5,.97,
0.22,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.97,.6,
0.75,.75,
.39,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
savefig(adhplot1,5,3.5)
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.80,.4,
0.52,.98,
0.22,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.97,.6,
0.75,.75,
.39,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
savefig(adhplot1,5,3.5)
ntxadh <- toplotadh("XR-NTX",mycolors[2],
0.80,.4,
0.51,.98,
0.22,.9,
1)
bupadh <- toplotadh("BUP-NX",mycolors[1],
0.97,.6,
0.75,.75,
.39,.9,
1)
adhplot1 <- ntxadh/bupadh #+ plot_annotation(tag_levels = "A")
adhplot1
savefig(adhplot1,5,3.5)
## For table
rbind(rev(table(preds_s1$TRT)),
rev(table(preds_s1$TRT[preds_s1$z==1])),
c(mean(preds_s1$z[preds_s1$a==1]),
mean(preds_s1$z[preds_s1$a==0])))
ntxadhsum <- summary(preds_s0$z1hat_1)
bupadhsum <- summary(preds_s0$z1hat_0)
foradhtable <- function(summary){
rbind(round(c(summary[[4]],summary[[3]],summary[[2]],summary[[5]]),2),
round(c(summary[[4]]*.75,summary[[3]]*.75,summary[[2]]*.75,summary[[5]]*.75),2),
round(c(summary[[4]]*.5,summary[[3]]*.5,summary[[2]]*.5,summary[[5]]*.5),2))
}
foradhtable(ntxadhsum)
foradhtable <- function(summary){
rbind(round(c(summary[[4]],summary[[3]],summary[[2]],summary[[5]]),3),
round(c(summary[[4]]*.75,summary[[3]]*.75,summary[[2]]*.75,summary[[5]]*.75),3),
round(c(summary[[4]]*.5,summary[[3]]*.5,summary[[2]]*.5,summary[[5]]*.5),3))
}
foradhtable(ntxadhsum)
foradhtable <- function(summary){
rbind(round(c(summary[[4]],summary[[3]],summary[[2]],summary[[5]]),2),
round(c(summary[[4]]*.75,summary[[3]]*.75,summary[[2]]*.75,summary[[5]]*.75),2),
round(c(summary[[4]]*.5,summary[[3]]*.5,summary[[2]]*.5,summary[[5]]*.5),2))
}
foradhtable(ntxadhsum)
foradhtable(bupadhsum)
## For table
rbind(rev(table(preds_s1$TRT)),
rev(table(preds_s1$TRT[preds_s1$z==1])),
c(mean(preds_s1$z[preds_s1$a==1]),
mean(preds_s1$z[preds_s1$a==0])))
## Crude trial results
table(preds_s1$y)
mean(preds_s1$y)
mean(preds_s1$y[preds_s1$a==1])
mean(preds_s1$y[preds_s1$a==0])
mean(preds_s1$y[preds_s1$a==1])-mean(preds_s1$y[preds_s1$a==0])
## Adjusted trial results
gettrialresults(trialestimator(preds))
## Adjusted trial results
round(gettrialresults(trialestimator(preds)),2)
## Adjusted trial results
round(gettrialresults(trialestimator(preds)),2)
## Transport results assuming no trial effects
round(getresults(oldestimator(preds)),2)
## New estimand: Approach A
#getresults(newestimator(preds,1,1)) #just to compare to old estimator
round(getresults(newestimator(preds,0.75,0.75)),2)
round(getresults(newestimator(preds,0.5,0.5)),2)
# Delta values -----------------------------------------------------------------
## XR-NTX
min1 <- 0.5
max1 <- 1
mode1_1 <- 0.6
mode1_2 <- 0.75
## BUP-NX
min0 <- .5
max0 <- 1
mode0_1 <- 0.75
mode0_2 <- 0.9
ndraws <- 10000
## Monte Carlo sampling from prob distributions
set.seed(11)
trapdraws <- tibble(
delta0 = rtrapezoid(n = ndraws, min0, mode0_1, mode0_2, max0, n1=2,n3=2,alpha=1),
delta1 = rtrapezoid(n = ndraws, min1, mode1_1, mode1_2, max1, n1=2,n3=2,alpha=1),
flag1 = factor(ifelse(delta1>delta0,1,0))
)
margadh_ntx=map(trapdraws$delta1, ~ mean(preds_s0$z1hat_1*.x))
margadh_bup=map(trapdraws$delta0, ~ mean(preds_s0$z1hat_0*.x))
fromdraws <- trapdraws |>
mutate(margadh_ntx = unlist(margadh_ntx),
margadh_bup = unlist(margadh_bup),
flag2 = factor(ifelse(margadh_ntx>margadh_bup,1,0)))
table(fromdraws$flag1)
table(fromdraws$flag2)
round(summary(fromdraws$margadh_ntx),3)
round(summary(fromdraws$margadh_ntx),2)
round(summary(fromdraws$margadh_bup),2)
round(summary(fromdraws$margadh_ntx[fromdraws$flag1==0]),2)
round(summary(fromdraws$margadh_bup[fromdraws$flag1==0]),2)
results <- map2(trapdraws$delta0,trapdraws$delta1,getresultsmc,data=preds)
fullresults <- cbind(fromdraws,reduce(results,rbind)) |>
mutate(rd_percent = rd*100,
rd_lcl_percent = rd_lcl*100,
rd_ucl_percent = rd_ucl*100)
getquantiles <- function(data){
round(c(quantile(data,0.5),
quantile(data,0.025),
quantile(data,0.975)),2)
}
# Simulation results
getquantiles(fullresults$r1)
getquantiles(fullresults$r0)
getquantiles(fullresults$rd)
getquantiles(fullresults$rd[fullresults$flag1==0])
getquantiles(fullresults$r1[fullresults$flag1==0])
getquantiles(fullresults$r0[fullresults$flag1==0])
getquantiles(fullresults$rd[fullresults$flag1==0])
# Incorporate random error
set.seed(11)
wre <- fullresults |>
mutate(r1wre = r1 - rnorm(ndraws,mean = 0,sd = r1_se),
r0wre = r0 - rnorm(ndraws,mean = 0,sd = r0_se),
rdwre = rd - rnorm(ndraws,mean = 0,sd = rd_se))
getquantiles(wre$r1wre)
getquantiles(wre$r0wre)
getquantiles(wre$rdwre)
getquantiles(wre$r1wre[wre$flag1==0])
getquantiles(wre$r0wre[wre$flag1==0])
getquantiles(wre$rdwre[wre$flag1==0])
